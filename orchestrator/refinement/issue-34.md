# Refinement: Issue #34 - [FEATURE] SonarQube MCP Server Integration

**Status**: Refinement Complete
**Generated**: 2026-01-09 17:18:41 UTC

## Clarified Story

Integrate a SonarQube MCP Server as a sibling Docker container managed by McpClientManager so the Orchestrator can query SonarQube metrics during SDLC workflows. Add SONAR_HOST_URL and SONAR_TOKEN to OrchestratorConfig (read from environment and not logged). The MCP server container image must be configurable at runtime. The MCP handshake must expose Sonar-related tools (minimum: sonarqube_get_new_issues and sonarqube_get_quality_gate_status) and the Orchestrator must be able to invoke these tools programmatically and parse responses. CodeReviewExecutor must detect when Sonar analysis exists for a PR/branch and call the new-issues tool when available; returned Sonar findings must be incorporated into the review output and clearly labeled as static analysis (distinct from AI/LLM findings), and when Sonar analysis is not available the executor must report Sonar data as unavailable (no silent failure). DodExecutor must call the quality-gate-status tool and fail the DoD when the returned status is in a configurable fail list (default includes ERROR and WARN). DodExecutor must also independently enforce configured metric thresholds (default coverage threshold = 80%) when the quality gate is too loose. Secrets (SONAR_TOKEN) must never be logged or persisted in plaintext and must be supplied only to the MCP container via environment or other secure mechanism. Behavior for network/TLS failures must surface clear errors from MCP handshake/tool invocations; executors must treat Sonar data as unavailable in those cases and retry behavior must be configurable. Implementation and tests must follow .NET 8, xUnit, Clean Architecture and Repository Pattern constraints. Unit and integration tests plus documentation (CI SonarScanner step, configuration, failure modes) must be added.

## Acceptance Criteria (10)

- Given SONAR_HOST_URL and SONAR_TOKEN are set in the environment, when OrchestratorConfig is initialized, then the Orchestrator must read SONAR_HOST_URL and SONAR_TOKEN from environment variables and must not log these values in plaintext during startup or runtime.
- Given McpClientManager has a configured Sonar MCP image, when McpClientManager initializes, then it must launch a Docker container using the configured image name/tag and perform an MCP handshake that lists Sonar-related tools including at minimum sonarqube_get_new_issues and sonarqube_get_quality_gate_status.
- Given the MCP handshake exposes sonarqube_get_new_issues, when CodeReviewExecutor checks a PR/branch that has Sonar analysis available, then it must invoke sonarqube_get_new_issues, receive a parseable response, and include returned Sonar findings in the review output clearly labeled as 'SonarQube findings' (distinct from AI-generated findings).
- Given the MCP handshake exposes sonarqube_get_new_issues, when CodeReviewExecutor inspects a PR/branch where Sonar analysis is not available or the tool returns a not-found/no-analysis response, then the CodeReviewExecutor must report that Sonar data is unavailable and must not fail silently.
- Given DodExecutor runs for a PR/branch, when it invokes sonarqube_get_quality_gate_status and the returned status is in the configured fail-list (default includes ERROR and WARN), then the DodExecutor must fail the DoD and surface the quality gate status and reason in the failure report.
- Given DodExecutor runs for a PR/branch and sonarqube_get_quality_gate_status returns a passing gate but the reported metrics (e.g., coverage) are below configured thresholds (default coverage threshold = 80%), when thresholds are configured in OrchestratorConfig, then DodExecutor must enforce the configured metric thresholds independently and fail the DoD if thresholds are not met.
- Given SONAR_TOKEN is provided to the system, when the system logs, stores, or returns data, then SONAR_TOKEN must never be written to logs, persisted in plaintext in the repository or config files, or returned in MCP tool responses; the token must only be supplied to the MCP container via environment or other secure mechanism.
- Given network or TLS failures occur during MCP handshake or tool invocation, when such failures happen, then the McpClientManager and tool-invocation code must surface a clear error, CodeReviewExecutor/DodExecutor must treat Sonar data as unavailable, and configured retry behavior must be attempted (retries/timeouts must be configurable in OrchestratorConfig).
- Given the codebase and test suite, when unit tests are run, then unit tests must cover: reading and masking of SONAR_HOST_URL/SONAR_TOKEN, McpClientManager container startup logic (mocked), handshake parsing of tool list, CodeReviewExecutor behavior when Sonar data is present and absent, and DodExecutor behavior for pass/fail/warn statuses and metric threshold enforcement.
- Given an integration test environment with either a running SonarQube instance or a test MCP server, when integration tests are executed (or documented local/integration steps are followed), then the end-to-end flow must be validated: container startup using the configured image, successful handshake exposing Sonar tools, invocation of sonarqube_get_new_issues and sonarqube_get_quality_gate_status, and correct handling of returned results by CodeReviewExecutor and DodExecutor.

## Open Questions (8)

**How to answer:**
1. Add a comment to the GitHub issue with your answers
2. Remove `blocked` and `user-review-required` labels
3. Add the `dor` label to re-trigger refinement

Refinement will read your comment, incorporate answers, and stop re-asking those questions.

- [ ] What are the exact request/response schemas for the MCP tools sonarqube_get_new_issues and sonarqube_get_quality_gate_status (full JSON contract)? If schemas are not fixed by the MCP server, who will provide and maintain the official MCP tool contract and where will it be documented?
- [ ] Which method should be used to detect that 'Sonar analysis is available' for a given PR/branch (preferred approach: query Sonar API for project/branch existence and recent analysis timestamp, rely on a CI success flag, or another approach)? Please confirm the detection algorithm.
- [ ] What is the authoritative mapping between Orchestrator repositories/branches/PRs and Sonar project keys/branches? Is there an existing naming convention or configuration file for project-key mapping, or must a mapping mechanism be introduced (and where will that mapping be stored)?
- [ ] How should the Sonar MCP container be networked relative to the SonarHost (e.g., use bridge networking vs host networking), and must we support TLS certificate validation options and proxy configuration (e.g., allow passing proxy env vars or custom CA bundles)? Please specify networking and TLS expectations.
- [ ] What are the default and configurable retry and timeout policies for MCP handshake and tool invocations (e.g., default per-call timeout in seconds, number of retry attempts, backoff strategy)? Please provide concrete defaults to implement and expose for configuration.
- [ ] Do we need to support multiple Sonar instances (multiple SONAR_HOST_URL/SONAR_TOKEN pairs) and, if so, how should credentials and selection per-repository or per-workflow be specified (e.g., per-repo config, OrchestratorConfig multi-entry, or external store)?
- [ ] What level of integration test coverage is required for CI: smoke tests only against a mocked MCP server, or full scenario tests that run with a real Sonar instance and a sample project analysis? Clarify whether using a mocked MCP server in CI is acceptable or if a real Sonar instance must be included for integration tests.
- [ ] Are there any compliance, secrets management, or audit requirements around storing/rotating SONAR_TOKEN (e.g., mandatory use of a secrets manager, rotation policy, audit logging) that the implementation must follow or document?

